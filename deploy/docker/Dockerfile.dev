# Stage 1: Base environment with system dependencies
FROM node:20-bullseye AS base

# Install system dependencies (cached layer)
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    python3-setuptools \
    build-essential \
    git \
    vim \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf python3 /usr/bin/python

# Install global Node.js tools (cached layer)
RUN npm install -g pnpm@latest tsx@latest

# Set working directory
WORKDIR /app

# Set environment variables
ENV NODE_ENV=development
ENV PNPM_HOME="/usr/local/bin"
ENV PATH="$PNPM_HOME:$PATH"

# Stage 2: Development environment with application code
FROM base AS development

# Create volumes for persistent data
VOLUME ["/app/node_modules", "/root/.pnpm-store"]

# Expose ports
EXPOSE 3000 9229

# Copy startup script (this layer rebuilds when script changes)
COPY deploy/docker/dev-start.sh /usr/local/bin/dev-start
RUN chmod +x /usr/local/bin/dev-start

# Default command for development
CMD ["/usr/local/bin/dev-start"]